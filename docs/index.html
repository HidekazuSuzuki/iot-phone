<!--
 * Copyright (c) 2014 IBM Corp.
 *
 * All rights reserved. This program and the accompanying materials
 * are made available under the terms of the Eclipse Public License v1.0
 * and Eclipse Distribution License v1.0 which accompany this distribution.
 *
 * The Eclipse Public License is available at
 *   http://www.eclipse.org/legal/epl-v10.html
 * and the Eclipse Distribution License is available at
 *   http://www.eclipse.org/org/documents/edl-v10.php.
 *
 * Contributors:
 *   Bryan Boyd - Initial implementation 
 -->

<!DOCTYPE html>
<html>

<head>
    <title>IoT Phone</title>
    <link rel='stylesheet' href='./device.css' />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="apple-mobile-web-app-capable" content="yes">
</head>

<body>
    <div class="outer-main">
        <div id="main" class="main">
            <h1>ðŸ“± IoT Phone ðŸ“¡</h1>
            <p style="padding-top:10px">
                <img id="connectionImage" src="./disconnected.svg" class="iot-connected-image"
                    style="vertical-align:middle">
                <span id="connection">Disconnected</span>
            </p>â€‹
            <h1>MQTT Broker:</h1>
            <form id="form">
                <p>
                    <label>FQDN:</label>
                    <input id="fqdn" type="text" value="public.cloud.shiftr.io" required>
                </p>
                <p>
                    <label>Port:</label>
                    <input id="port" type="text" value="1883" required>
                </p>
                <p>
                    <label>Protocol:</label>
                    <select id="protocol" onchange="selectProtocol(this.value)" required>
                        <option value="mqtt" selected>MQTT</option>
                        <option value="mqtts">MQTT over TLS</option>
                        <option value="ws">WebSocket</option>
                        <option value="wss">WebSocket over TLS</option>
                    </select>
                </p>
                <p>
                    <label>Student ID:</label>
                    <input id="studentId" type="text" value="" required>
                </p>
                <p>
                    <label>User:</label>
                    <input id="userName" type="text" value="public">
                </p>
                <p>
                    <label>Password:</label>
                    <input id="password" type="text" value="public">
                </p>
                <button type="button" id="connectButton" onclick="connectBroker();" disabled>Connect MQTT Broker</button>
                <h1>MQTT Topic:</h1>
                <input id="topic" type="text" value="sensor" required>
            </form>
        </div>
        <div class="main">
            <h1>Sensor Data:</h1>
            <table class="data-table">
                <tr class="table-title">
                    <th colspan="3">Movement</th>
                </tr>
                <tr class="data-title">
                    <th>Alpha</th>
                    <th>Beta</th>
                    <th>Gamma</th>
                </tr>
                <tr>
                    <td id="alpha">0</td>
                    <td id="beta">0</td>
                    <td id="gamma">0</td>
                </tr>
            </table>
            <table class="data-table">
                <tr class="table-title">
                    <th colspan="3">Acceleration</th>
                </tr>
                <tr class="data-title">
                    <th>X</th>
                    <th>Y</th>
                    <th>Z</th>
                </tr>
                <tr>
                    <td id="accx">0</td>
                    <td id="accy">0</td>
                    <td id="accz">0</td>
                </tr>
            </table>
        </div>
        <button type="button" id="publishButton" onclick="enableSensors();">Publish sensor data</button>
        <div class="iot-footer-pad"></div>
    </div>
    <script type="text/javascript" src="https://code.jquery.com/jquery-3.6.0.js"></script>
    <script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>
    <script type="text/javascript">
        const form = document.getElementById("form");
        const connectButton = document.getElementById("connectButton");
        var ax = 0, ay = 0, az = 0, oa = 0, ob = 0, og = 0;
        var client;
        var isConnected = false;
        window.msgCount = 0;

        form.addEventListener("input", update);
        form.addEventListener("change", update);

        function update() {
            const isRequired = form.checkValidity();
            if (isRequired) {
                connectButton.disabled = false;
                connectButton.style.opacity = 1;
                connectButton.style.cursor = "pointer";
            } else {
                connectButton.disabled = true;
                connectButton.style.opacity = 0.2;
                connectButton.style.cursor = "none";
            }
        }

        function enableSensors() {
            if (typeof DeviceOrientationEvent.requestPermission === 'function') {
                DeviceOrientationEvent.requestPermission().then(function (response) {
                    if (response === 'granted') {
                        window.addEventListener("deviceorientation", function (event) {
                            oa = (event.alpha || 0);
                            ob = (event.beta || 0);
                            og = (event.gamma || 0);
                            if (event.webkitCompassHeading) {
                                oa = 360 - event.webkitCompassHeading;
                            }
                            document.getElementById("alpha").innerHTML = oa.toFixed(2);
                            document.getElementById("beta").innerHTML = ob.toFixed(2);
                            document.getElementById("gamma").innerHTML = og.toFixed(2);
                        });
                    }
                }).catch(function (e) { alert(e); });
            } else {
                window.addEventListener("deviceorientationabsolute", function (event) {
                    oa = (event.alpha || 0);
                    ob = (event.beta || 0);
                    og = (event.gamma || 0);
                    document.getElementById("alpha").innerHTML = oa.toFixed(2);
                    document.getElementById("beta").innerHTML = ob.toFixed(2);
                    document.getElementById("gamma").innerHTML = og.toFixed(2);
                });
            }
            if (typeof DeviceMotionEvent.requestPermission === 'function') {
                DeviceMotionEvent.requestPermission().then(function (response) {
                    if (response === 'granted') {
                        window.addEventListener("devicemotion", function (event) {
                            ax = parseFloat((event.acceleration.x || 0));
                            ay = parseFloat((event.acceleration.y || 0));
                            az = parseFloat((event.acceleration.z || 0));
                            document.getElementById("accx").innerHTML = ax.toFixed(2);
                            document.getElementById("accy").innerHTML = ay.toFixed(2);
                            document.getElementById("accz").innerHTML = az.toFixed(2);
                        });
                    }
                }).catch(function (e) { alert(e); });
            } else {
                window.addEventListener("devicemotion", function (event) {
                    ax = parseFloat((event.accelerationIncludingGravity.x || 0));
                    ay = parseFloat((event.accelerationIncludingGravity.y || 0));
                    az = parseFloat((event.accelerationIncludingGravity.z || 0));
                    document.getElementById("accx").innerHTML = ax.toFixed(2);
                    document.getElementById("accy").innerHTML = ay.toFixed(2);
                    document.getElementById("accz").innerHTML = az.toFixed(2);
                });
            }
            setInterval(publish, 500);
        }

        function publish() {
            if (isConnected) {
                var topic = $('#topic').val();
                var payload = {
                    "movement": {
                        "alpha": parseFloat(oa.toFixed(2)),
                        "beta": parseFloat(ob.toFixed(2)),
                        "gamma": parseFloat(og.toFixed(2))
                    },
                    "acceleration": {
                        "x": parseFloat(ax.toFixed(2)),
                        "y": parseFloat(ay.toFixed(2)),
                        "z": parseFloat(az.toFixed(2))
                    }
                };

                client.publish(topic, JSON.stringify(payload), (error) => {
                    if (error) {
                        console.error(error);
                    } else {
                        console.log("Published: " + JSON.stringify(payload));
                        window.msgCount++;
                        $("#publishButton").html("Published messages: " + window.msgCount);
                        $("#publishButton").prop("disabled", true);
                    }
                });
            }
        }

        function connectBroker() {
            var url = $('#protocol').val() + '://' + $('#fqdn').val() + ':' + parseInt($('#port').val());
            var studentId = $('#studentId').val();
            
            changeConnectionStatusImage("./connecting.svg");
            document.getElementById("connection").innerHTML = "Connecting";
            console.log("Connecting device to MQTT Broker... (" + url + ")");
            
            client = mqtt.connect(url, {
                protocolId: 'MQIsdp',
                protocolVersion: 3,
                clientId: 'mqttjs_' + studentId,
                clean: true,
                connectTimeout: 4000,
                username: $('#userName').val(),
                password: $('#password').val(),
                reconnectPeriod: 1000,
            });

            client.on('connect', () => {
                console.log("Connected Successfully!");
                isConnected = true;
                changeConnectionStatusImage("./connected.svg");
                document.getElementById("connection").innerHTML = "Connected";
            });

            client.on('reconnect', () => {
                console.log("Starting reconnect...");
                isConnected = false;
                changeConnectionStatusImage("./disconnected.svg");
                document.getElementById("connection").innerHTML = "Reconnecting";
            });

            client.on('close', () => {
                console.log("Closed.");
                isConnected = false;
                changeConnectionStatusImage("./disconnected.svg");
                document.getElementById("connection").innerHTML = "Disconnected";
            });

            client.on('offline', () => {
                console.log("now offline.");
                isConnected = false;
                changeConnectionStatusImage("./disconnected.svg");
                document.getElementById("connection").innerHTML = "Disconnected";
            });

            client.on('error', (error) => {
                console.log("ERROR!");
                isConnected = false;
                changeConnectionStatusImage("./disconnected.svg");
                document.getElementById("connection").innerHTML = "Error! " + error;
                client.end();
            });
        };

        function changeConnectionStatusImage(image) {
            document.getElementById("connectionImage").src = image;
        }

        function selectProtocol(selected) {
            var port;
            switch (selected) {
                case 'mqtt':
                    port = 1883;
                    break;
                case 'mqtts':
                    port = 8883;
                    break;
                case 'ws':
                    port = 80;
                    break;
                case 'wss':
                    port = 443;
                    break;
            }
            document.getElementById("port").value = port;
        }
    </script>
</body>

</html>